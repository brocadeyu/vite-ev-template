/**
 * @license
 * Cesium - https://github.com/CesiumGS/cesium
 * Version 1.96
 *
 * Copyright 2011-2022 Cesium Contributors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Columbus View (Pat. Pend.)
 *
 * Portions licensed separately.
 * See https://github.com/CesiumGS/cesium/blob/main/LICENSE.md for full licensing details.
 */
define(["exports","./defaultValue-4607806f","./DeveloperError-46384437"],(function(t,e,a){"use strict";var n=Object.freeze({TERRAIN:0,IMAGERY:1,TILES3D:2,BIN:3,IMAGE:4,FILE:5});const o=["model","imagery","terrain","3DTile","gltfBin","images","file"];function i(t){this._windowIDB=e.defaultValue(t,void 0),this._iDB=void 0,this.dataName="EVIDB",this.version=2,this._dbDivides=10,this._dbDivideTable={},this._dbTransaction={},this._isDbTransactionClock=!1,this._dbTransactionQueue=[],this._dbLoadDatas={},this._dbSaveDatas={}}Object.defineProperties(i.prototype,{iDB:{get:function(){return this._iDB}}}),i.prototype.createIDB=function(t){const n=this.dataName,i=this.version;if(e.defined(this._windowIDB)){const s=this,r=this._windowIDB.open(n,i);r.onupgradeneeded=function(t){const e=t.target.result;for(let t=0;t<o.length;t++)if(!e.objectStoreNames.contains(o[t])){const a=e.createObjectStore(o[t],{keyPath:"key",autoIncrement:!0});"model"===o[t]?a.createIndex("name","name",{unique:!1}):a.createIndex("name","name",{unique:!0})}for(let t=0;t<s._dbDivides;t++){const a="imagery_"+t;e.objectStoreNames.contains(a)||e.createObjectStore(a,{keyPath:"name"})}},r.onsuccess=function(a){const n=a.target.result;if(!s._dbDivideTable.imagery){s._dbDivideTable.imagery=[];for(let t=0;t<s._dbDivides;t++)s._dbDivideTable.imagery.push("imagery_"+t)}s._iDB=n,e.defined(t)&&t()},r.onerror=function(t){throw new a.DeveloperError("indexDB Open failed")}}},i.closeIDB=function(t,a){e.defined(this._iDB)&&this._iDB.name===t&&this._iDB.version===a&&this._iDB.close()};const s=67108864;i.prototype.saveModelArrayBuffer=function(t,a,n,o,i){if(e.defined(this._iDB)&&this._iDB.name===t&&this._iDB.version===a)if(this._iDB.objectStoreNames.contains(n)){const t=this._iDB.transaction([n],"readwrite").objectStore(n);let e=0,a=0;const r=Math.ceil(i.byteLength/s);for(let n=0;n<r;n++){a+=s;const r={name:o,chunkId:n,data:i.slice(e,a)},c=t.put(r);e=a,c.onsuccess=function(t){console.log("arraybuffer writed success")},c.onerror=function(t){console.log("arraybuffer writed error")}}}else console.log(`${n}:该表不存在!`);else console.log(`${t}:保存数据有问题!`)},i.prototype.downloadModelArrayBuffer=function(t,a,n,o,i,s,r){if(e.defined(this._iDB)&&this._iDB.name===t&&this._iDB.version===a)if(this._iDB.objectStoreNames.contains(n)){const t=this._iDB.transaction([n],"readonly").objectStore(n),e=i,a=o,c=new Array;let d=0;const l=t.index("name").openCursor(IDBKeyRange.only(o));l.onsuccess=function(t){const n=t.target.result;if(n){const t=n.value;if(t.name===a){const e=new Uint8Array(t.data);c.push(e),d+=e.byteLength}n.continue()}else{let t=0;const a=new Uint8Array(d);for(let e=0;e<c.length;e++)a.set(c[e],t),t+=c[e].length;c.length>0?r(e,a):s(e)}},l.onerror=function(t){console.log("索引查询失败!")}}else s(i);else console.log(`${t}:下载数据有问题!`)},i.prototype.saveTerrainData=function(t,a){const n="terrain";if(e.defined(this._iDB))if(this._iDB.objectStoreNames.contains(n)){if(!t.data)return void console.log("数据为空");const o={name:t.keyName,level:t.level,x:t.x,y:t.y,data:t.data,upsample:e.defaultValue(t.upsample,!1)},i=(new Date).getTime();this._dbSaveDatas.terrain||(this._dbSaveDatas.terrain=[]),this._dbSaveDatas.terrain.push({terrainData:o,callback:a,timestamp:i}),this.initTransactionAndLoadData(n,"readwrite",this.saveTerrainDatas)}else console.log("terrain:该表不存在!");else console.log(`${t}:保存数据有问题!`)},i.prototype.saveTerrainDatas=function(t){const e=this._dbTransaction[t+"_readwrite"].objectStore(t);this._dbSaveDatas[t].forEach((t=>{const a=t.terrainData,o=t.callback;t.timestamp;const i=e.put(a);i.onsuccess=function(t){o(n.TERRAIN,1,{keyName:a.name})},i.onerror=function(t){o(n.TERRAIN,0,{keyName:a.name})}})),this._dbSaveDatas[t]=[]},i.prototype.downloadTerrainData=function(t,a){const n="terrain";if(e.defined(this._iDB)){if(this._iDB.objectStoreNames.contains(n)){const e=(new Date).getTime();this._dbLoadDatas.terrain||(this._dbLoadDatas.terrain=[]),this._dbLoadDatas.terrain.push({terrainData:t,callback:a,timestamp:e}),this.initTransactionAndLoadData(n,"readonly",this.getTerrainDatas)}}else console.log(`${t}:下载数据有问题!`)},i.prototype.getTerrainDatas=function(t){const e=this._dbTransaction[t+"_readonly"].objectStore(t);this._dbLoadDatas[t].forEach((t=>{const a=t.terrainData,o=t.callback;t.timestamp;const i=e.index("name").openCursor(a.keyName);i.onsuccess=function(t){const e=t.target.result;e&&e.value.data.buffer?(a.level=e.value.level,a.x=e.value.x,a.y=e.value.y,a.upsample=e.value.upsample,a.data=e.value.data,o(n.TERRAIN,1,a)):o(n.TERRAIN,0,a)},i.onerror=function(t){console.log("索引查询失败!")}})),this._dbLoadDatas[t]=[]},i.prototype.saveImagery=function(t,a){const n="imagery_"+(t.x+t.y)%this._dbDivides,o=(new Date).getTime();if(e.defined(this._iDB))if(this._iDB.objectStoreNames.contains(n)){const i={name:t.keyName,level:t.level,x:t.x,y:t.y,data:t.data,upsample:e.defaultValue(t.upsample,!1)};this._dbSaveDatas.imagery||(this._dbSaveDatas.imagery={}),this._dbSaveDatas.imagery[n]||(this._dbSaveDatas.imagery[n]=[]),this._dbSaveDatas.imagery[n].push({terrainData:i,callback:a,timestamp:o}),this.initTransactionAndLoadData("imagery","readwrite",this.saveImageryDatas)}else console.log(`${n}:该表不存在!`);else console.log(`${t}:保存数据有问题!`)},i.prototype.saveImageryDatas=function(t){for(var e in this._dbSaveDatas[t]){const a=this._dbTransaction[t+"_readwrite"].objectStore(e);this._dbSaveDatas[t][e].forEach((t=>{const e=t.terrainData,o=t.callback;t.timestamp;const i=a.put(e);i.onsuccess=function(t){o(n.IMAGERY,1)},i.onerror=function(t){o(n.IMAGERY,0)}})),this._dbSaveDatas[t][e]=[]}},i.prototype.downloadImagery=function(t,a){const n="imagery_"+(t.x+t.y)%this._dbDivides;if(e.defined(this._iDB)){if(this._iDB.objectStoreNames.contains(n)){const e=(new Date).getTime();this._dbLoadDatas.imagery||(this._dbLoadDatas.imagery={}),this._dbLoadDatas.imagery[n]||(this._dbLoadDatas.imagery[n]=[]),this._dbLoadDatas.imagery[n].push({terrainData:t,callback:a,timestamp:e}),this.initTransactionAndLoadData("imagery","readonly",this.getImageryDatas)}}else console.log(`${t}:下载数据有问题!`)},i.prototype.getImageryDatas=function(t){for(var e in this._dbLoadDatas[t]){const a=this._dbTransaction[t+"_readonly"].objectStore(e);this._dbLoadDatas[t][e].forEach((t=>{const e=t.terrainData,o=t.callback;t.timestamp;const i=a.get(e.keyName);i.onsuccess=function(t){const a=t.target.result;a?(e.level=a.level,e.x=a.x,e.y=a.y,e.upsample=a.upsample,e.data=a.data,o(n.IMAGERY,1,e)):o(n.IMAGERY,0,e)},i.onerror=function(t){console.log("索引查询失败!")}})),this._dbLoadDatas[t][e]=[]}},i.prototype.save3DTileArrayBuffer=function(t,e){const a="3DTile";if(this._iDB.objectStoreNames.contains(a)){const n={name:t.keyName,meshPrimitives:t.meshPrimitives,data:t.data},o=(new Date).getTime();this._dbSaveDatas["3DTile"]||(this._dbSaveDatas["3DTile"]=[]),this._dbSaveDatas["3DTile"].push({terrainData:n,callback:e,timestamp:o}),this.initTransactionAndLoadData(a,"readwrite",this.save3DTileDatas)}else console.log("3DTile:该表不存在!")},i.prototype.save3DTileDatas=function(t){const e=this._dbTransaction[t+"_readwrite"].objectStore(t);this._dbSaveDatas[t].forEach((t=>{let a=t.terrainData;const o=t.callback;t.timestamp;const i=e.put(a);i.onsuccess=function(t){a.data=void 0,a.meshPrimitives=[],a=void 0,o(n.TILES3D,1)},i.onerror=function(t){o(n.TILES3D,0)}})),this._dbSaveDatas[t]=[]},i.prototype.download3DTileArrayBuffer=function(t,e){const a="3DTile";if(this._iDB.objectStoreNames.contains(a)){const n=(new Date).getTime();this._dbLoadDatas["3DTile"]||(this._dbLoadDatas["3DTile"]=[]),this._dbLoadDatas["3DTile"].push({terrainData:t,callback:e,timestamp:n}),this.initTransactionAndLoadData(a,"readonly",this.get3DTileDatas)}else console.log("3DTile不存在!")},i.prototype.get3DTileDatas=function(t){const a=this._dbTransaction[t+"_readonly"].objectStore(t);this._dbLoadDatas[t].forEach((t=>{const o=t.terrainData,i=t.callback;t.timestamp;const s=a.index("name").openCursor(o.keyName);s.onsuccess=function(t){const a=t.target.result;e.defined(a)?(o.data=a.value.data,o.meshPrimitives=a.value.meshPrimitives,i(n.TILES3D,1,o)):i(n.TILES3D,0,o)},s.onerror=function(t){console.log("索引查询失败!")}})),this._dbLoadDatas[t]=[]},i.prototype.saveGltfBin=function(t,e){const a="gltfBin";if(this._iDB.objectStoreNames.contains(a)){const o=this._iDB.transaction([a],"readwrite").objectStore(a),i={name:t.keyName,data:t.data},s=o.put(i);s.onsuccess=function(a){t.data=void 0,t=void 0,e(n.BIN,1)},s.onerror=function(t){e(n.BIN,0)}}else console.log("gltfBin:该表不存在!")},i.prototype.downloadGltfBin=function(t,a){const o="gltfBin";if(this._iDB.objectStoreNames.contains(o)){const i=this._iDB.transaction([o],"readonly").objectStore(o).index("name").openCursor(IDBKeyRange.only(t.keyName));i.onsuccess=function(o){const i=o.target.result;e.defined(i)?(t.data=i.value.data,a(n.BIN,1,t)):a(n.BIN,0,t)},i.onerror=function(t){console.log("索引查询失败!")}}},i.prototype.saveFile=function(t,e){const a="file";if(this._iDB.objectStoreNames.contains(a)){const o=this._iDB.transaction([a],"readwrite").objectStore(a),i={name:t.keyName,data:t.data},s=o.put(i);s.onsuccess=function(a){t.data=void 0,t=void 0,e(n.FILE,1)},s.onerror=function(t){e(n.FILE,0)}}else console.log("file:该表不存在!")},i.prototype.downloadFile=function(t,a){const o="file";if(this._iDB.objectStoreNames.contains(o)){const i=this._iDB.transaction([o],"readonly").objectStore(o).index("name").openCursor(IDBKeyRange.only(t.keyName));i.onsuccess=function(o){const i=o.target.result;e.defined(i)?(t.data=i.value.data,a(n.FILE,1,t)):a(n.FILE,0,t)},i.onerror=function(t){console.log("索引查询失败!")}}},i.prototype.saveImage=function(t,e){const a="images";if(this._iDB.objectStoreNames.contains(a)){const o=this._iDB.transaction([a],"readwrite").objectStore(a),i={name:t.keyName,data:t.data},s=o.put(i);s.onsuccess=function(a){t.data=void 0,t=void 0,e(n.IMAGE,1)},s.onerror=function(t){e(n.IMAGE,0)}}else console.log("images:该表不存在!")},i.prototype.downloadImage=function(t,a){const o="images";if(this._iDB.objectStoreNames.contains(o)){const i=this._iDB.transaction([o],"readonly").objectStore(o).index("name").openCursor(IDBKeyRange.only(t.keyName));i.onsuccess=function(o){const i=o.target.result;e.defined(i)?(t.data=i.value.data,a(n.IMAGE,1,t)):a(n.IMAGE,0,t)},i.onerror=function(t){console.log("索引查询失败!")}}},i.prototype.initTransactionAndLoadData=function(t,e,a){if(-1==this._dbTransactionQueue.findIndex((a=>a.tableName==t&&a.type==e))&&this._dbTransactionQueue.push({tableName:t,type:e,callback:a}),this._dbTransactionQueue.length>0&&!this._isDbTransactionClock){this._isDbTransactionClock=!0;const t=this._dbTransactionQueue.shift(),e=t.tableName,a=t.type,n=t.callback;let o=e+"_"+a,i=this;this._dbTransaction[o]=this._iDB.transaction("imagery"==e?this._dbDivideTable.imagery:[e],a),this._dbTransaction[o].oncomplete=t=>{i._dbTransaction[o]=void 0,i._isDbTransactionClock=!1,i._dbTransactionQueue.length>0&&i.initTransactionAndLoadData(i._dbTransactionQueue[0].tableName,i._dbTransactionQueue[0].type,i._dbTransactionQueue[0].callback)},this._dbTransaction[o].onerror=t=>{i._dbTransaction[o]=void 0,i._isDbTransactionClock=!1,i._dbTransactionQueue.length>0&&i.initTransactionAndLoadData(i._dbTransactionQueue[0].tableName,i._dbTransactionQueue[0].type,i._dbTransactionQueue[0].callback)},n.call(this,e)}},t.EV_IndexDBType=n,t.EV_IndexedDBProvider=i}));
